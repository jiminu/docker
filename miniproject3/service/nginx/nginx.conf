events {
    worker_connections 1024;
}

http {
    # 로그 설정
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # Docker 내부 DNS 서버 설정 / 스프링 서비스가 늦게 뜰 경우 nginx가 다시 잡기 위한 설정 
    resolver 127.0.0.11 valid=30s ipv6=off;
    resolver_timeout 5s;

    # User 서비스 업스트림 (헬스체크 방식)
    upstream user-backend {
        least_conn;
        server user:8080 max_fails=3 fail_timeout=10s;
        keepalive 32;
        keepalive_requests 100;
        keepalive_timeout 60s;
    }

    # RestArea 서비스 업스트림
    upstream restarea-backend {
        least_conn;
        server restarea:8080 max_fails=3 fail_timeout=10s;
        keepalive 32;
        keepalive_requests 100;
        keepalive_timeout 60s;
    }

    # RestArea-Unit 서비스 업스트림
    upstream restarea-unit-backend {
        least_conn;
        server restarea-unit:8080 max_fails=3 fail_timeout=10s;
        keepalive 32;
        keepalive_requests 100;
        keepalive_timeout 60s;
    }

    # Content 서비스 업스트림
    upstream content-backend {
        least_conn;
        server content:8080 max_fails=3 fail_timeout=10s;
        keepalive 32;
        keepalive_requests 100;
        keepalive_timeout 60s;
    }

    # OpenAPI 서비스 업스트림
    upstream openapi-backend {
        least_conn;
        server openapi:8080 max_fails=3 fail_timeout=10s;
        keepalive 32;
        keepalive_requests 100;
        keepalive_timeout 60s;
    }

    # TmapAPI 서비스 업스트림
    upstream tmapapi-backend {
        least_conn;
        server tmapapi:8080 max_fails=3 fail_timeout=10s;
        keepalive 32;
        keepalive_requests 100;
        keepalive_timeout 60s;
    }

    # OpenAI 서비스 업스트림
    upstream openai-backend {
        least_conn;
        server openai:8080 max_fails=3 fail_timeout=10s;
        keepalive 32;
        keepalive_requests 100;
        keepalive_timeout 60s;
    }

    # User 서비스 - 8081 포트
    server {
        listen 8081;
        
        location / {
            proxy_pass http://user-backend;
            
            # 타임아웃 설정
            proxy_connect_timeout 10s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            
            # 헤더 전달
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # HTTP 1.1 + Keepalive 사용
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            
            # 에러 발생시 재시도
            proxy_next_upstream error timeout http_502 http_503 http_504;
            proxy_next_upstream_tries 2;
            proxy_next_upstream_timeout 15s;
        }
    }

    # RestArea 서비스 - 8082 포트
    server {
        listen 8082;
        
        location / {
            proxy_pass http://restarea-backend;
            proxy_connect_timeout 10s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_next_upstream error timeout http_502 http_503 http_504;
            proxy_next_upstream_tries 2;
            proxy_next_upstream_timeout 15s;
        }
    }

    # RestArea-Unit 서비스 - 8083 포트
    server {
        listen 8083;
        
        location / {
            proxy_pass http://restarea-unit-backend;
            proxy_connect_timeout 10s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_next_upstream error timeout http_502 http_503 http_504;
            proxy_next_upstream_tries 2;
            proxy_next_upstream_timeout 15s;
        }
    }

    # Content 서비스 - 8084 포트
    server {
        listen 8084;
        
        location / {
            proxy_pass http://content-backend;
            proxy_connect_timeout 10s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_next_upstream error timeout http_502 http_503 http_504;
            proxy_next_upstream_tries 2;
            proxy_next_upstream_timeout 15s;
        }
    }

    # OpenAPI 서비스 - 8085 포트
    server {
        listen 8085;
        
        location / {
            proxy_pass http://openapi-backend;
            proxy_connect_timeout 10s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_next_upstream error timeout http_502 http_503 http_504;
            proxy_next_upstream_tries 2;
            proxy_next_upstream_timeout 15s;
        }
    }

    # TmapAPI 서비스 - 8086 포트
    server {
        listen 8086;
        
        location / {
            proxy_pass http://tmapapi-backend;
            proxy_connect_timeout 10s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_next_upstream error timeout http_502 http_503 http_504;
            proxy_next_upstream_tries 2;
            proxy_next_upstream_timeout 15s;
        }
    }

    # OpenAI 서비스 - 8087 포트
    server {
        listen 8087;
        
        location / {
            proxy_pass http://openai-backend;
            proxy_connect_timeout 10s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_next_upstream error timeout http_502 http_503 http_504;
            proxy_next_upstream_tries 2;
            proxy_next_upstream_timeout 15s;
        }
    }
}
